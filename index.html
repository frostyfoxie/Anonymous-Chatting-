<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Secure Group Chat</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',sans-serif;}
html,body{width:100%;height:100%;}
.container{display:flex;width:100%;height:100%;flex-direction:column;}
header{background:linear-gradient(135deg,#4a6cf7,#82a0ff);color:white;padding:15px;text-align:center;}
header h1{display:flex;justify-content:center;align-items:center;gap:10px;font-size:1.8rem;}
.chat-area{flex:1;padding:10px;overflow-y:auto;display:flex;flex-direction:column;gap:10px;background:#f9fafc;}
.message{padding:10px 15px;border-radius:20px;max-width:70%;word-break:break-word;position:relative;}
.incoming{background:#e0e7ff;align-self:flex-start;}
.outgoing{background:linear-gradient(135deg,#4a6cf7,#82a0ff);color:white;align-self:flex-end;}
.message-sender{font-weight:600;font-size:0.85rem;margin-bottom:3px;}
.message-img{max-width:200px;border-radius:12px;margin-top:5px;}
.message-input{display:flex;padding:10px;gap:5px;background:white;border-top:1px solid #ddd;}
.message-input input[type=text]{flex:1;padding:10px;border-radius:12px;border:1px solid #ddd;}
input[type=file]{display:none;}
.btn-file{padding:10px;border-radius:8px;background:#6b7280;color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;}
</style>
</head>
<body>
<div class="container">
<header><h1><i class="fas fa-comments"></i> SecureGroup Chat</h1></header>
<div class="chat-area" id="chatArea"></div>
<div class="message-input">
<input type="text" id="messageText" placeholder="Type message..." onkeypress="if(event.key==='Enter') sendMessage()">
<label class="btn-file"><i class="fas fa-image"></i><input type="file" id="imageUpload" accept="image/*" onchange="sendImage(event)"></label>
<button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey:"AIzaSyCqobhf4HFUdBIZJMF-s9uW3e0-EGh327I",
  authDomain:"anonymous-chatting-c6712.firebaseapp.com",
  databaseURL:"https://anonymous-chatting-c6712-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"anonymous-chatting-c6712",
  storageBucket:"anonymous-chatting-c6712.appspot.com",
  messagingSenderId:"124331866043",
  appId:"1:124331866043:web:8be37be9d84974b4a0b69e"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Username
const adjectives=['Mysterious','Anonymous','Secret','Hidden','Stealthy','Private','Unknown','Incognito','Covert','Discreet'];
const nouns=['Phoenix','Panther','Fox','Falcon','Wolf','Eagle','Lion','Tiger','Hawk','Owl'];
function generateUsername(){return adjectives[Math.floor(Math.random()*adjectives.length)]+nouns[Math.floor(Math.random()*nouns.length)]+Math.floor(Math.random()*1000);}
let username=generateUsername();
let userId=localStorage.getItem('userId')|| (Math.random().toString(36).substring(2)+Date.now().toString(36));
localStorage.setItem('userId',userId);

// State
let currentGroup='TEST'; // default group for simplicity
let encryptionKey=null;

// AES-GCM
async function deriveKey(password,saltStr){
const salt=new TextEncoder().encode(saltStr);
const keyMaterial=await crypto.subtle.importKey('raw', new TextEncoder().encode(password), {name:'PBKDF2'}, false, ['deriveKey']);
return crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations:100000,hash:'SHA-256'},keyMaterial,{name:'AES-GCM',length:256},false,['encrypt','decrypt']);
}
async function encryptData(data){const iv=crypto.getRandomValues(new Uint8Array(12));const encrypted=await crypto.subtle.encrypt({name:'AES-GCM',iv},encryptionKey,data);return {iv:Array.from(iv),data:btoa(String.fromCharCode(...new Uint8Array(encrypted)))};}
async function decryptData(obj){return await crypto.subtle.decrypt({name:'AES-GCM',iv:new Uint8Array(obj.iv)},encryptionKey,Uint8Array.from(atob(obj.data),c=>c.charCodeAt(0)));}

// Initialize
(async()=>{encryptionKey=await deriveKey('defaultpass',currentGroup);
db.ref(`groups/${currentGroup}/users/${userId}`).set({username,lastSeen:Date.now()});
listenMessages();})();

// Send message
async function sendMessage(){
const text=document.getElementById('messageText').value.trim();if(!text)return;
const enc=await encryptData(new TextEncoder().encode(text));
const msgRef=db.ref(`groups/${currentGroup}/messages`).push();
msgRef.set({userId,username,encryptedText:enc,timestamp:Date.now()});
setTimeout(()=>msgRef.remove(),24*60*60*1000);
document.getElementById('messageText').value='';
}

// Send image
async function sendImage(event){
const file=event.target.files[0];if(!file)return;
const arrayBuffer=await file.arrayBuffer();
const enc=await encryptData(arrayBuffer);
const msgRef=db.ref(`groups/${currentGroup}/messages`).push();
msgRef.set({userId,username,encryptedImage:enc,timestamp:Date.now()});
setTimeout(()=>msgRef.remove(),60*1000);
event.target.value='';
}

// Listen messages
function listenMessages(){
const chatArea=document.getElementById('chatArea');chatArea.innerHTML='';
const ref=db.ref(`groups/${currentGroup}/messages`);
ref.off();
ref.on('child_added',async snap=>{
const msg=snap.val();
const div=document.createElement('div');div.classList.add('message',msg.userId===userId?'outgoing':'incoming');
try{
if(msg.encryptedText){const dec=new TextDecoder().decode(await decryptData(msg.encryptedText));div.innerHTML=`<div class="message-sender">${msg.username}</div>${dec}`;}
else if(msg.encryptedImage){const dec=new Blob([await decryptData(msg.encryptedImage)]);const url=URL.createObjectURL(dec);div.innerHTML=`<div class="message-sender">${msg.username}</div><img src="${url}" class="message-img">`;}
}catch{div.innerHTML=`<div class="message-sender">${msg.username}</div>[Cannot decrypt]`;}
chatArea.appendChild(div);chatArea.scrollTop=chatArea.scrollHeight;
});
}
</script>
</body>
</html>
