<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Secure Ephemeral Chat</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',sans-serif;}
html,body{height:100%;width:100%;overflow:hidden;}
.container{display:flex;height:100vh;width:100vw;}
.sidebar{width:280px;background:#4f46e5;color:white;display:flex;flex-direction:column;padding:20px;}
.sidebar h2{margin-bottom:15px;font-size:1.3rem;}
.group-list{flex:1;overflow-y:auto;}
.group-item{padding:10px;border-radius:8px;margin-bottom:8px;cursor:pointer;background:rgba(255,255,255,0.1);}
.group-item:hover,.group-item.active{background:rgba(255,255,255,0.3);}
.join-group{margin-top:15px;display:flex;flex-direction:column;gap:8px;}
.join-group input{padding:10px;border:none;border-radius:8px;}
.join-group button{padding:10px;border:none;border-radius:8px;background:#2563eb;color:white;cursor:pointer;font-weight:600;}
.main{flex:1;display:flex;flex-direction:column;}
.chat-header{padding:15px;background:#6366f1;color:white;font-size:1.2rem;}
.chat-area{flex:1;padding:15px;overflow-y:auto;display:flex;flex-direction:column;gap:10px;background:#f9fafc;}
.message{padding:12px 16px;border-radius:18px;max-width:70%;word-break:break-word;position:relative;animation:fadeIn 0.3s;}
.incoming{background:#e0e7ff;align-self:flex-start;}
.outgoing{background:linear-gradient(135deg,#4f46e5,#6366f1);color:white;align-self:flex-end;}
.message-sender{font-weight:600;font-size:0.85rem;margin-bottom:4px;}
.message-img{max-width:200px;border-radius:12px;margin-top:5px;}
.message-input{display:flex;padding:15px;gap:10px;border-top:1px solid #ddd;background:white;}
.message-input input[type=text]{flex:1;padding:10px;border-radius:12px;border:1px solid #ddd;}
.message-input input[type=file]{display:none;}
.btn-file{padding:10px;border-radius:8px;background:#6b7280;color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
<div class="container">
  <div class="sidebar">
    <h2><i class="fas fa-users"></i> Groups</h2>
    <div class="group-list" id="groupList"></div>
    <div class="join-group">
      <input type="text" id="groupIdInput" placeholder="Group ID">
      <input type="password" id="groupPasswordInput" placeholder="Group Password">
      <button onclick="joinGroup()">Join/Create</button>
    </div>
  </div>
  <div class="main">
    <div class="chat-header" id="chatHeader">Select or Join a Group</div>
    <div class="chat-area" id="chatArea"></div>
    <div class="message-input">
      <input type="text" id="messageText" placeholder="Type message..." onkeypress="if(event.key==='Enter') sendMessage()">
      <label class="btn-file">
        <i class="fas fa-image"></i>
        <input type="file" id="imageUpload" accept="image/*" onchange="sendImage(event)">
      </label>
      <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
    </div>
  </div>
</div>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCqobhf4HFUdBIZJMF-s9uW3e0-EGh327I",
  authDomain: "anonymous-chatting-c6712.firebaseapp.com",
  databaseURL: "https://anonymous-chatting-c6712-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "anonymous-chatting-c6712",
  storageBucket: "anonymous-chatting-c6712.appspot.com",
  messagingSenderId: "124331866043",
  appId: "1:124331866043:web:8be37be9d84974b4a0b69e"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// State
let userId = localStorage.getItem('userId') || (Math.random().toString(36).substring(2)+Date.now().toString(36));
localStorage.setItem('userId',userId);
let username = 'Anon'+Math.floor(Math.random()*10000);
let activeGroupId = null;
let encryptionKey = null;

// Utils
async function deriveKey(password, saltStr){
  const salt = new TextEncoder().encode(saltStr);
  const keyMaterial = await crypto.subtle.importKey('raw', new TextEncoder().encode(password), {name:'PBKDF2'}, false, ['deriveKey']);
  return crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations:100000,hash:'SHA-256'},keyMaterial,{name:'AES-GCM',length:256},false,['encrypt','decrypt']);
}
async function encryptText(text){
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const enc = new TextEncoder().encode(text);
  const encrypted = await crypto.subtle.encrypt({name:'AES-GCM',iv},encryptionKey,enc);
  return JSON.stringify({iv:Array.from(iv),data:btoa(String.fromCharCode(...new Uint8Array(encrypted)))});
}
async function decryptText(str){
  const obj = JSON.parse(str);
  const decrypted = await crypto.subtle.decrypt({name:'AES-GCM',iv:new Uint8Array(obj.iv)},encryptionKey,Uint8Array.from(atob(obj.data),c=>c.charCodeAt(0)));
  return new TextDecoder().decode(decrypted);
}

// Group join
async function joinGroup(){
  const gid = document.getElementById('groupIdInput').value.trim();
  const pwd = document.getElementById('groupPasswordInput').value;
  if(!gid||!pwd) return alert('Enter Group ID and Password');
  activeGroupId = gid;
  encryptionKey = await deriveKey(pwd,gid);
  db.ref(`groups/${gid}/users/${userId}`).set({username,lastSeen:Date.now()});
  document.getElementById('chatHeader').textContent = 'Group: '+gid;
  addGroupToList(gid);
  listenMessages();
}

// Add group to sidebar
function addGroupToList(gid){
  const list = document.getElementById('groupList');
  if([...list.children].some(c=>c.textContent===gid)) return;
  const div = document.createElement('div'); div.className='group-item active'; div.textContent=gid;
  div.onclick=()=>{activeGroupId=gid;document.getElementById('chatHeader').textContent='Group: '+gid; listenMessages();}
  list.appendChild(div);
}

// Send text
async function sendMessage(){
  if(!activeGroupId) return;
  const text = document.getElementById('messageText').value.trim();
  if(!text) return;
  const encrypted = await encryptText(text);
  const msgRef = db.ref(`groups/${activeGroupId}/messages`).push();
  msgRef.set({userId,username,encryptedText:encrypted,timestamp:Date.now()});
  setTimeout(()=>msgRef.remove(),24*60*60*1000);
  document.getElementById('messageText').value='';
}

// Send image (ephemeral)
async function sendImage(event){
  if(!activeGroupId) return;
  const file = event.target.files[0]; if(!file) return;
  const arrayBuffer = await file.arrayBuffer();
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const encrypted = await crypto.subtle.encrypt({name:'AES-GCM',iv},encryptionKey,arrayBuffer);
  const encryptedBase64 = btoa(String.fromCharCode(...new Uint8Array(encrypted)));
  const msgRef = db.ref(`groups/${activeGroupId}/messages`).push();
  msgRef.set({userId,username,encryptedImage:encryptedBase64,iv:Array.from(iv),timestamp:Date.now()});
  setTimeout(()=>msgRef.remove(),60*1000);
  event.target.value='';
}

// Listen messages
function listenMessages(){
  if(!activeGroupId) return;
  const chatArea = document.getElementById('chatArea');
  chatArea.innerHTML='';
  const ref = db.ref(`groups/${activeGroupId}/messages`);
  ref.off();
  ref.on('child_added',async snap=>{
    const msg = snap.val();
    const div=document.createElement('div'); div.classList.add('message',msg.userId===userId?'outgoing':'incoming');
    if(msg.encryptedText){
      try{ div.innerHTML=`<div class="message-sender">${msg.username}</div>`+await decryptText(msg.encryptedText); }
      catch{ div.innerHTML=`<div class="message-sender">${msg.username}</div>[Cannot decrypt]`; }
    }else if(msg.encryptedImage){
      try{
        const decrypted = await crypto.subtle.decrypt({name:'AES-GCM',iv:new Uint8Array(msg.iv)},encryptionKey,Uint8Array.from(atob(msg.encryptedImage),c=>c.charCodeAt(0)));
        const blob = new Blob([decrypted]); const url = URL.createObjectURL(blob);
        div.innerHTML=`<div class="message-sender">${msg.username}</div><img src="${url}" class="message-img">`;
      }catch{ div.innerHTML=`<div class="message-sender">${msg.username}</div>[Cannot decrypt image]`; }
    }
    chatArea.appendChild(div); chatArea.scrollTop=chatArea.scrollHeight;
  });
}
</script>
</body>
</html><div class="container">
  <div class="sidebar">
    <h2><i class="fas fa-users"></i> Groups</h2>
    <div id="groupList" class="group-list">
      <p class="empty-text">No groups joined yet</p>
    </div>
    <div class="join-group">
      <input type="text" id="groupId" placeholder="Group ID">
      <input type="password" id="groupPassword" placeholder="Password">
      <button class="btn btn-primary" onclick="joinGroup()">Join Group</button>
      <button class="btn btn-secondary" onclick="createGroup()">Create Group</button>
    </div>
  </div>

  <div class="main">
    <div id="chatHeader" class="chat-header">Select a group</div>
    <div id="chatArea" class="chat-area"></div>
    <div class="message-input">
      <input type="text" id="messageText" placeholder="Type a message..." onkeypress="if(event.key==='Enter'){sendMessage()}">
      <label class="btn btn-secondary" for="imageUpload"><i class="fas fa-image"></i></label>
      <input type="file" id="imageUpload" accept="image/*" onchange="sendImage(event)">
      <button class="btn btn-primary" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCqobhf4HFUdBIZJMF-s9uW3e0-EGh327I",
  authDomain: "anonymous-chatting-c6712.firebaseapp.com",
  databaseURL: "https://anonymous-chatting-c6712-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "anonymous-chatting-c6712",
  storageBucket: "anonymous-chatting-c6712.appspot.com",
  messagingSenderId: "124331866043",
  appId: "1:124331866043:web:8be37be9d84974b4a0b69e"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

let userId = localStorage.getItem('userId') || (localStorage.setItem('userId', Math.random().toString(36).substring(2)), localStorage.getItem('userId'));
let username = `Anon${Math.floor(Math.random()*10000)}`;
let groups = {};
let activeGroupId = null;
let encryptionKey = null;

async function deriveKey(password, salt){
  const keyMaterial = await crypto.subtle.importKey('raw', new TextEncoder().encode(password), {name:'PBKDF2'}, false, ['deriveKey']);
  return await crypto.subtle.deriveKey({name:'PBKDF2',salt:new TextEncoder().encode(salt),iterations:100000,hash:'SHA-256'}, keyMaterial, {name:'AES-GCM',length:256}, false, ['encrypt','decrypt']);
}

async function encryptText(text){
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const encrypted = await crypto.subtle.encrypt({name:'AES-GCM', iv}, encryptionKey, new TextEncoder().encode(text));
  return JSON.stringify({iv:Array.from(iv), data:Array.from(new Uint8Array(encrypted))});
}

async function decryptText(payload){
  const obj = JSON.parse(payload);
  const iv = new Uint8Array(obj.iv);
  const data = new Uint8Array(obj.data);
  const decrypted = await crypto.subtle.decrypt({name:'AES-GCM', iv}, encryptionKey, data);
  return new TextDecoder().decode(decrypted);
}

function createGroup(){
  const id = Math.random().toString(36).substring(2,8).toUpperCase();
  const pwd = Math.random().toString(36).substring(2,10);
  document.getElementById('groupId').value = id;
  document.getElementById('groupPassword').value = pwd;
  alert(`Group Created!\nID: ${id}\nPassword: ${pwd}`);
}

async function joinGroup(){
  const groupId = document.getElementById('groupId').value.trim();
  const password = document.getElementById('groupPassword').value;
  if(!groupId || !password){alert('Enter both Group ID and Password'); return;}
  encryptionKey = await deriveKey(password, groupId);
  activeGroupId = groupId;
  if(!groups[groupId]) groups[groupId]=true;
  renderGroupList();
  document.getElementById('chatHeader').innerText=`Group: ${groupId}`;
  listenMessages();
  cleanOldMessages(24);
}

function renderGroupList(){
  const list=document.getElementById('groupList');
  list.innerHTML='';
  Object.keys(groups).forEach(g=>{
    const div=document.createElement('div');
    div.classList.add('group-item');
    if(g===activeGroupId) div.classList.add('active');
    div.innerText=g;
    div.onclick=()=>{activeGroupId=g; document.getElementById('chatHeader').innerText=`Group: ${g}`; listenMessages();}
    list.appendChild(div);
  });
}

async function sendMessage(){
  const msgInput = document.getElementById('messageText');
  const text = msgInput.value.trim();
  if(!text||!activeGroupId) return;
  const encrypted = await encryptText(text);
  db.ref(`groups/${activeGroupId}/messages`).push({userId,username,encryptedText:encrypted,timestamp:Date.now()});
  msgInput.value='';
}

async function sendImage(event){
  if(!activeGroupId) return;
  const file = event.target.files[0];
  if(!file) return;
  const arrayBuffer = await file.arrayBuffer();
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const encryptedBuffer = await crypto.subtle.encrypt({name:'AES-GCM', iv}, encryptionKey, arrayBuffer);
  const blob = new Blob([encryptedBuffer]);
  const storageRef = storage.ref(`groups/${activeGroupId}/${Date.now()}_${file.name}`);
  storageRef.put(blob).then(async ()=>{
    const url = await storageRef.getDownloadURL();
    const encryptedMeta = await encryptText(url);
    db.ref(`groups/${activeGroupId}/messages`).push({userId,username,encryptedImage:encryptedMeta,timestamp:Date.now()});
  }).catch(console.error);
  event.target.value='';
}

function listenMessages(){
  if(!activeGroupId) return;
  const chatArea=document.getElementById('chatArea');
  chatArea.innerHTML='';
  const ref=db.ref(`groups/${activeGroupId}/messages`);
  ref.off();
  ref.on('child_added',async snapshot=>{
    const msg=snapshot.val();
    const div=document.createElement('div');
    div.classList.add('message');
    div.classList.add(msg.userId===userId?'outgoing':'incoming');
    if(msg.encryptedText){
      try{const content=await decryptText(msg.encryptedText); div.innerHTML=`<div class="message-sender">${msg.username}</div>${content}`;}
      catch{div.innerHTML=`<div class="message-sender">${msg.username}</div>[Cannot decrypt]`;}
    }else if(msg.encryptedImage){
      try{const url=await decryptText(msg.encryptedImage); div.innerHTML=`<div class="message-sender">${msg.username}</div><img src="${url}" class="message-img">`;}
      catch{div.innerHTML=`<div class="message-sender">${msg.username}</div>[Cannot decrypt image]`;}
    }
    chatArea.appendChild(div);
    chatArea.scrollTop=chatArea.scrollHeight;
  });
}

// Auto-delete messages older than N hours
function cleanOldMessages(hours=24){
  if(!activeGroupId) return;
  const cutoff=Date.now()-hours*3600*1000;
  const ref=db.ref(`groups/${activeGroupId}/messages`);
  ref.orderByChild('timestamp').endAt(cutoff).once('value',snapshot=>{
    snapshot.forEach(child=>child.ref.remove());
  });
}

// Run cleanup periodically
setInterval(()=>cleanOldMessages(24),30*60*1000);
</script>
</body>
</html>
